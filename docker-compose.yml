services:
  postgres-standalone:
    image: "postgis/postgis:latest"
    container_name: postgres-standalone
    platform: linux/amd64
    environment:
      - "POSTGRES_DB=asap"
      - "POSTGRES_PASSWORD=asap"
      - "POSTGRES_USER=asap"
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U asap -d asap"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-standalone:
    image: minio/minio:latest
    container_name: minio-standalone
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Web UI
    environment:
      MINIO_ROOT_USER: asap
      MINIO_ROOT_PASSWORD: asap
    entrypoint: >
      /bin/sh -c "
        mkdir -p /data/asap &&
        exec minio server /data --console-address :9001
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 10s

  backend-standalone:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: backend-standalone
    ports:
      - "8080:8080"
    environment:
      - APP_BASE_API_URL=http://localhost:8080
      - APP_BASE_UI_URL=http://localhost:3000
      - APP_MAIL_FROM=asap@kfdlabs.com
      - APP_MAIL_NAME=ASAP
      - AWS_ACCESS_KEY=asap
      - AWS_SECRET_KEY=asap
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT=http://minio-standalone:9000
      - AWS_S3_PRESIGNED_URL_ENDPOINT=http://localhost:9000
      - AWS_S3_BUCKET=asap
      - DB_HOST=postgres-standalone
      - DB_PORT=5432
      - DB_NAME=asap
      - DB_USERNAME=asap
      - DB_PASSWORD=asap
      - REDIS_HOST=redis-standalone
      - REDIS_PORT=6379
      - DOCKER_COMPOSE_ENABLED=false
      - SMTP_HOST=${SMTP_HOST:-smtp.example.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - GOOGLE_CLIENT_ID=
      - GOOGLE_CLIENT_SECRET=
      - SPRING_PROFILES_ACTIVE=standalone
      - APP_RATE_LIMIT_ENABLED=true
      - APP_RATE_LIMIT_RPS=15
      - APP_LINK_EXPIRATION_MINUTES=60
      - APP_ATTACHMENT_EXPIRATION_DAYS=7
      - DB_MAX_POOL_SIZE=50
      - DB_IDLE_TIMEOUT=300000
      - DB_MIN_IDLE=10
      - DB_CONNECTION_TIMEOUT=20000
      - JPA_SHOW_SQL=false
      - LIQUIBASE_ENABLED=true
      - FILE_UPLOAD_MAX_SIZE=10MB
      - JWT_SECRET=${JWT_SECRET:-changeme-generate-a-256bit-secret}
      - JWT_ACCESS_TOKEN_VALIDITY=3600000
      - JWT_REFRESH_TOKEN_VALIDITY=86400000
      - ELASTIC_METRICS_ENABLED=false
      - API_KEYS_SECRET=${API_KEYS_SECRET:-changeme-generate-api-key-secret}
    depends_on:
      postgres-standalone:
        condition: service_healthy
      minio-standalone:
        condition: service_healthy
